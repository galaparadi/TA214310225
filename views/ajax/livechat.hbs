<div class="row equal-height-grid">
  <div class="col l9">
    <div class="card">
      <div class="card-content">
        <span class="card-title" id="chat-username">Jane Doe</span>
        <p>Currently Online</p>
      </div>

      <div class="divider"></div>

      <div class="card-content chat-container" style="overflow:scroll;max-height:300px">
        <div class="chat-wrapper">

          <div class="chat-message left">
            <img class="circle"
              src="//cdn.shopify.com/s/files/1/1775/8583/t/1/assets/portrait1.jpg?v=1218798423999129079" alt="avatar">
            Lo-fi you probably haven't heard of them etsy leggings raclette kickstarter four dollar toast. Raw denim
            fingerstache food truck chia health goth synth. Forage man bun intelligentsia freegan PBR&amp;B banh mi
            asymmetrical chambray.
          </div>

          <div class="chat-message right">
            <img class="circle"
              src="//cdn.shopify.com/s/files/1/1775/8583/t/1/assets/portrait2.jpg?v=15342908036415923195" alt="avatar">
            Lo-fi you probably haven't heard of them.
          </div>
          <div class="chat-message right">
            etsy leggings raclette kickstarter four dollar toast.
          </div>
          <div class="chat-message right">
            Raw denim fingerstache food truck chia health goth synth. Forage man bun intelligentsia freegan PBR&amp;B
            banh mi asymmetrical chambray.
          </div>

          <div class="chat-message left">
            <img class="circle"
              src="//cdn.shopify.com/s/files/1/1775/8583/t/1/assets/portrait1.jpg?v=1218798423999129079" alt="avatar">
            Raw denim fingerstache food truck chia health goth synth.
          </div>

        </div>
      </div>

      <div class="chat-input">
        <form action="">
          <div class="chat-input-bar">
            <input type="text" id="textarea1" class="materialize-textarea" style="height: 72px;"></input>
            <button type="submit">
              <i class="material-icons">send</i>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col l3">
    <div class="card">
      <div class="card-content">
        <span class="card-title">Friends</span>
        <p>12 Friends online</p>
      </div>
      <ul class="collection flush">
        {{#each users}}
        <li class="collection-item avatar chat-users" data-username="{{this.username}}">
          <div class="badged-circle {{#if this.online}} online {{/if}}">
            <img class="circle" src="https://ui-avatars.com/api/?name={{this.username}}" alt="avatar">
          </div>
          <span class="title">{{this.username}}</span>
          <p class="truncate">lorem</p>
        </li>
        {{/each}}
      </ul>
    </div>
  </div>
</div>

<script>
  $('.chat-container').scrollTop(document.querySelector('.chat-container').scrollHeight - document.querySelector('.chat-container').clientHeight)

  function sendMessage(textInput) {
    sendChat(textInput.val());
    socket.emit('private-chat', textInput.val(), $('button').val());
    textInput.val('')
  }
  function getReceivanId(username) {
    socket.emit('ask-private-chat', { dest: username });
  }

  socket.on('someone-ask-private-chat', msg => {
    if (msg.dest === username) {
      socket.emit('receive-private-chat', msg)
    }
  });
  socket.on('receive-private-chat', msg => {
    if (msg.dest === $('#chat-username').text())
      $('button').val(msg.destId);
  });

  socket.on('sending-dochub', msg => {
    receiveChat(msg);
  });
  socket.on('private-chat', msg => {
    receiveChat(msg);
  })


  let sendChat = (message) => {
    let chatText = `<div class="chat-message right">
            <img class="circle"
              src="//cdn.shopify.com/s/files/1/1775/8583/t/1/assets/portrait2.jpg?v=15342908036415923195" alt="avatar">
            ${message}
          </div>`;
    $('.chat-message:last-child').after(chatText)
    $('.chat-container').scrollTop(document.querySelector('.chat-container').scrollHeight - document.querySelector('.chat-container').clientHeight)
  }

  let receiveChat = (message) => {
    let chatText = `<div class="chat-message left">
            <img class="circle"
              src="//cdn.shopify.com/s/files/1/1775/8583/t/1/assets/portrait2.jpg?v=15342908036415923195" alt="avatar">
            ${message}
          </div>`;
    $('.chat-message:last-child').after(chatText)
    $('.chat-container').scrollTop(document.querySelector('.chat-container').scrollHeight - document.querySelector('.chat-container').clientHeight)
  }

  $('.chat-input>form').submit(evt => {
    evt.preventDefault();
    sendMessage($('#textarea1'));
  });

  $('.chat-users').click(function (evt) {
    evt.stopPropagation()
    /* 1. Tambah class active */
    $('.chat-users').removeClass('active');
    $(this).toggleClass('active');

    /* 2. Ambil Username*/
    $('#chat-username').text($(this).attr('data-username'))
    getReceivanId($('#chat-username').text());
  })
</script>